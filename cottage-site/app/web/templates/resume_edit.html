{% extends "base.html" %}
{% block content %}
<section class="container mx-auto px-4 py-12 max-w-5xl">
  <h1 class="text-3xl font-bold">Edit Resume</h1>
  <p class="mt-2 text-slate-400">Use Markdown to format your resume. Links are allowed and sanitized.</p>

  <form method="post" action="/resume/edit" class="mt-6 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Editor -->
      <div>
        <label for="content" class="block text-sm font-medium text-slate-300">Content (Markdown)</label>
        <textarea id="content" name="content" rows="18" class="mt-2 w-full rounded-md bg-slate-800 border border-slate-700 px-3 py-2 text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-600">{{ (resume.content if resume else '') | e }}</textarea>
      </div>

      <!-- Live Preview -->
      <div>
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-slate-300">Live Preview</h2>
          <span class="text-xs text-slate-500">Sanitized</span>
        </div>
        <div id="md-preview" class="prose prose-invert max-w-none mt-2 rounded-md border border-slate-700 bg-slate-800 px-4 py-3 overflow-auto min-h-[10rem]"></div>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <a href="/resume" class="px-3 py-1.5 rounded-md border border-slate-700 text-slate-200 hover:bg-slate-800">Cancel</a>
      <button type="submit" class="px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700">Save</button>
    </div>
  </form>

  <!-- Markdown Help -->
  <details class="mt-8 group">
    <summary class="cursor-pointer select-none flex items-center justify-between px-4 py-3 rounded-md border border-slate-700 bg-slate-800 text-slate-200 hover:bg-slate-700">
      <span class="font-medium">Markdown Help</span>
      <svg class="w-4 h-4 text-slate-400 group-open:rotate-180 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
    </summary>
    <div class="mt-3 space-y-4 text-sm text-slate-300">
      <div>
        <p class="text-slate-400 mb-1">Headings</p>
        <pre class="bg-slate-800 border border-slate-700 rounded p-3 overflow-auto"><code># H1
## H2
### H3</code></pre>
      </div>
      <div>
        <p class="text-slate-400 mb-1">Emphasis</p>
        <pre class="bg-slate-800 border border-slate-700 rounded p-3 overflow-auto"><code>**bold**  *italic*  ~~strikethrough~~</code></pre>
      </div>
      <div>
        <p class="text-slate-400 mb-1">Lists</p>
        <pre class="bg-slate-800 border border-slate-700 rounded p-3 overflow-auto"><code>- Item 1
- Item 2
  - Nested

1. First
2. Second</code></pre>
      </div>
      <div>
        <p class="text-slate-400 mb-1">Links</p>
        <pre class="bg-slate-800 border border-slate-700 rounded p-3 overflow-auto"><code>[Text](https://example.com "Title")</code></pre>
      </div>
      <div>
        <p class="text-slate-400 mb-1">Code</p>
        <pre class="bg-slate-800 border border-slate-700 rounded p-3 overflow-auto"><code>Inline `code`

```python
print("hello")
```</code></pre>
      </div>
      <div>
        <p class="text-slate-400 mb-1">Blockquote</p>
        <pre class="bg-slate-800 border border-slate-700 rounded p-3 overflow-auto"><code>> A wise quote</code></pre>
      </div>
    </div>
  </details>

  <!-- Client-side Markdown rendering libs -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const textarea = document.getElementById('content');
      const preview = document.getElementById('md-preview');
      if (!textarea || !preview || !window.markdownit || !window.DOMPurify) return;

      const md = window.markdownit({ html: false, linkify: true, typographer: true });
      // Force all links to open in new tab with safe rel
      const defaultRender = md.renderer.rules.link_open || function(tokens, idx, options, env, self) { return self.renderToken(tokens, idx, options); };
      md.renderer.rules.link_open = function (tokens, idx, options, env, self) {
        const tIndex = tokens[idx].attrIndex('target');
        if (tIndex < 0) tokens[idx].attrPush(['target', '_blank']); else tokens[idx].attrs[tIndex][1] = '_blank';
        const relIndex = tokens[idx].attrIndex('rel');
        if (relIndex < 0) tokens[idx].attrPush(['rel', 'noopener nofollow']); else tokens[idx].attrs[relIndex][1] = 'noopener nofollow';
        return defaultRender(tokens, idx, options, env, self);
      };

      const ALLOWED_TAGS = [
        'p','br','hr','pre','code','blockquote',
        'ul','ol','li',
        'h1','h2','h3','h4','h5','h6',
        'em','strong','del','a','img'
      ];
      const ALLOWED_ATTR = {
        'a': ['href','title','target','rel'],
        'img': ['src','alt','title','loading','referrerpolicy']
      };

      // Enforce http/https-only images and add privacy/perf attrs after sanitization
      DOMPurify.addHook('afterSanitizeAttributes', (node) => {
        if (node.tagName === 'IMG') {
          const src = node.getAttribute('src') || '';
          const ok = /^https?:\/\//i.test(src);
          if (!ok) {
            if (node.parentNode) node.parentNode.removeChild(node);
          } else {
            node.setAttribute('loading', 'lazy');
            node.setAttribute('referrerpolicy', 'no-referrer');
          }
        }
      });

      const render = () => {
        const raw = textarea.value || '';
        let html = md.render(raw);
        const allowedUri = /^(?:(?:https?|mailto):|\/)/i;
        html = DOMPurify.sanitize(html, { ALLOWED_TAGS, ALLOWED_ATTR, ALLOWED_URI_REGEXP: allowedUri });
        preview.innerHTML = html;
        // After injection, wrap images with anchors to open in new tab (avoid double-wrapping)
        preview.querySelectorAll('img').forEach(img => {
          if (img.closest('a')) return;
          const src = img.getAttribute('src') || '';
          if (!src) return;
          const a = document.createElement('a');
          a.href = src;
          a.target = '_blank';
          a.rel = 'noopener nofollow';
          img.parentNode.insertBefore(a, img);
          a.appendChild(img);
        });
      };

      textarea.addEventListener('input', render);
      render();
    });
  </script>
</section>
{% endblock %}
